# 更新日志

## v0.2.3 - 2026-01-04

### 🚀 自动化发布

#### GitHub Actions 自动发布
- 更新 RELEASE.md 并推送到 main 分支即可自动发布
- 自动从 RELEASE.md 提取最新版本号
- 自动更新 package.json 版本号
- 自动创建 git tag 并推送
- 自动从 RELEASE.md 提取 changelog 创建 GitHub Release

### 🎨 画廊页面优化

#### 沉浸模式
- 新增沉浸模式开关，隐藏图片下方的标题、分类等文本
- 沉浸模式下图片间距缩小，实现紧密排布
- 对宫格视图和瀑布视图有效

#### 移动端优化
- 宫格视图：移动端 2 列 → 平板 3 列 → 大屏 6 列
- 瀑布视图：移动端 2 列 → 平板 3 列 → 大屏 5 列
- 间距响应式：移动端更紧凑
- 工具栏响应式优化，搜索框宽度自适应

---

## v0.2.2 - 2026-01-04

### 🎨 叙事详情页重新设计

#### 左右分栏布局
- 桌面端采用左右分栏：左侧文章内容，右侧图片画廊
- 左侧文章区域支持 sticky 滚动
- 右侧图片区域包含大图预览和缩略图网格

#### 图片显示优化
- 大图预览保持原始比例，竖图左右留黑边
- 单击缩略图切换预览，双击打开详情弹窗
- 当前选中图片高亮显示

#### 移动端适配
- 移动端改为垂直堆叠布局
- 图片区域显示在文章内容下方、评论区上方
- 缩略图改为水平滚动条

### 🐛 Bug 修复

#### 类型错误修复
- 修复 `LogsTab` 和 `BlogTab` 的 settings 类型不匹配问题
- 修复 `i18n.ts` 中重复的 `compression_size` 属性

---

## v0.2.1 - 2026-01-04

### 🚀 性能优化

#### 公共设置接口缓存
- 合并 `/api/comments/settings` 到 `/api/settings/public`
- 新增构建版本号缓存机制，减少重复 API 请求
- 部署后缓存自动失效，用户立即获取新配置

#### 照片详情弹窗优化
- 修复切换 Tab 时重复请求叙事接口的问题
- 使用 CSS 隐藏替代条件渲染，保留组件状态
- 只有切换到叙事 Tab 时才请求数据

### 🐛 Bug 修复

#### 接口权限修复
- 修复 `/api/settings/public` 返回 401 的问题
- 原因：`hono/storage.ts` 的 `/*` 中间件拦截了所有请求

### 🎨 UI 改进

#### 叙事相册图片
- 移除黑白滤镜效果，改用透明度区分当前/非当前图片

---

## v0.2 - 2026-01-04

### 🌐 国际化

#### 存储管理页面完整国际化
- 存储提供商选项支持中英文翻译（本地存储/Cloudflare R2/GitHub）
- 文件状态标签国际化（已关联/孤立文件/缺失文件/缺失原图/缺失缩略图）
- 统计卡片标签国际化
- 帮助说明文本国际化
- 图片预览 alt 属性国际化
- 新增 `i18n.ts` 中 30+ 条存储相关翻译

### 🔧 路径修复

#### 上传路径显示优化
- 上传页面始终显示根路径前缀（配置的 Path Prefix 或 `/`）
- 用户可清楚看到当前根路径，避免输入重复路径

#### 已上传图片路径编辑修复
- 编辑照片路径时显示 `/` 前缀，表示从存储桶根路径开始
- 修复 R2 存储的 `move` 方法，直接使用绝对路径而非拼接 basePath
- 修复 GitHub 存储的 `move` 方法，同样使用绝对路径
- 解决路径重复问题（如 `2026/2026/xxx.jpg`）

### ✨ 存储管理增强

#### 存储扫描功能
- 新增存储整理页面 (`/admin/storage`)
- 支持扫描本地/R2/GitHub 三种存储
- 文件状态检测：已关联、孤立文件、缺失文件
- 细分缺失类型：缺失原图、缺失缩略图
- 按文件夹分组显示，支持折叠展开
- 可调整列宽的表格界面

#### 缺失文件处理
- 点击缺失文件可打开重新上传弹窗
- 支持上传替换缺失的原图或缩略图
- 保留原有数据库记录（标题、分类等）

#### 缩略图生成
- 已关联文件支持一键生成缩略图
- 显示缩略图状态（有/无/生成中）

### 🛠️ 技术改进

#### 存储 API
- 新增 `hono/storage.ts` 存储管理 API
- 新增 `hono/photos.ts` 照片批量操作 API
- 存储扫描支持全量扫描模式
- R2/GitHub 存储新增 `list` 方法支持

#### 组件新增
- `MissingFileUploadModal` - 缺失文件上传弹窗
- `SimpleDeleteDialog` - 简化删除确认对话框
- `DraftRestoreDialog` - 草稿恢复对话框
- `ImageUploadSettingsModal` - 图片上传设置弹窗
- `StoryPhotoPanel` - 叙事照片面板
- `StoryPreviewModal` - 叙事预览弹窗

---

## 2026-01-03

### 💾 本地草稿系统

#### 博客自动保存
- 博客编辑器新增自动保存功能
- 编辑内容每 2 秒自动保存到本地 IndexedDB
- 支持多条博客草稿同时保存
- 重新编辑时自动恢复最新草稿
- 发布成功后自动清理对应草稿

#### 草稿管理页面
- 新增「草稿」Tab 页面，统一管理所有本地草稿
- 显示叙事草稿（来自快速编辑器，只读）
- 显示博客草稿列表（可删除）
- 支持预览草稿内容
- 显示草稿保存时间和状态

### 🔒 安全增强

#### 照片删除保护
- 新增照片删除前的叙事关联校验功能
- 如果照片已关联到叙事（Story），将无法直接删除
- 删除确认对话框会显示关联的叙事列表
- 用户需要先从叙事中移除这些照片，然后再删除

### ✨ 叙事系统更新

#### 列表页面重新设计
- 叙事列表采用非对称网格布局重新设计
- 更现代化的视觉呈现

#### 快速编辑器增强
- 新增文件重排序功能
- 嵌入快速创建工具入口
- 优化编辑体验

---

### 📝 API 变更

#### 后端 API
- 新增 `GET /api/admin/photos/:id/stories` - 查询单张照片关联的叙事
- 新增 `POST /api/admin/photos/check-stories` - 批量检查多张照片的叙事关联
- 修改 `DELETE /api/admin/photos/:id` - 删除前检查叙事关联，如有关联返回错误

#### 前端
- 修改删除确认对话框，支持显示关联叙事警告
- 添加加载状态显示
- 如果有关联叙事，仅显示取消按钮，阻止删除操作

#### 国际化
- 添加中英文提示文本支持

---

## 2026-01-02

### ✨ 新功能

#### 叙事系统增强
- 新增叙事预览模态框，支持画廊和灯箱效果

#### 管理后台改进
- 上传表单增强：分类可选，显示存储路径
- 相册工具栏重新设计，支持可折叠筛选器
- 精选照片切换 UX 改进
- 照片详情面板显示存储路径
- Tab 组件与路由页面整合

#### 编辑器优化
- Milkdown 编辑器添加浅色模式文字颜色覆盖

#### 部署配置
- Docker 配置添加中国镜像仓库支持
- 简化并重组 .env.example 配置文件